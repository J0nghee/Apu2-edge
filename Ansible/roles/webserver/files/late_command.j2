set -x

cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

#toglie cancelletto e imposta ¨yes¨
sed 's/#\?\(PasswordAuthentication\s*\).*$/\1 no/' /etc/ssh/sshd_config > temp.txt

mv -f temp.txt /etc/ssh/sshd_config

sed 's/#\?\(PubkeyAuthentication\s*\).*$/\1 yes/' /etc/ssh/sshd_config > temp.txt

mv -f temp.txt /etc/ssh/sshd_config

if [ ! -d "/home/user/.ssh" ]
then
	mkdir /home/user/.ssh
	chmod 700 /home/user/.ssh
	touch /home/user/.ssh/authorized_keys
	chmod 600 /home/user/.ssh/authorized_keys
	chown -R user /home/user/.ssh 
fi

echo {{ istance_ssh_key_content }} >> /home/user/.ssh/authorized_keys

chown -R user /home/user/.ssh 

systemctl restart sshd
